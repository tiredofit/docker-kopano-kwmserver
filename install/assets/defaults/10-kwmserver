#!/usr/bin/with-contenv bash

CONFIG_PATH=${CONFIG_PATH:-"/config/"}
LOG_FILE=${LOG_FILE:-"kwmserver.log"}
LOG_LEVEL=${LOG_LEVEL:-"DEBUG"}
LOG_PATH=${LOG_PATH:-"/logs/"}
LOG_TIMESTAMPS=${LOG_TIMESTAMPS:-"TRUE"}
LOG_TYPE=${LOG_TYPE:-"FILE"}
SERVER_ENABLE_HTTP=${SERVER_ENABLE_HTTP:-"FALSE"}
SERVER_ENABLE_HTTPS=${SERVER_ENABLE_HTTPS:-"FALSE"}
SERVER_LISTEN_PORT=${SERVER_LISTEN_PORT_:-236}
SERVER_LISTEN_PORT_SECURE=${SERVER_LISTEN_PORT_SECURE:-237}
SETUP_TYPE=${SETUP_TYPE:-"AUTO"}
KWMSERVER_CONFIG_FILE=${KWMSERVER_CONFIG_FILE:-"kwmserverd.cfg"}
KWMSERVER_CONFIG_FILE_REGISTRATION=${KWMSERVER_CONFIG_FILE_REGISTRATION:-"kwmserverd-registration.yml"}
KWMSERVER_DISABLE_TLS_VALIDATION=${KWMSERVER_DISABLE_TLS_VALIDATION:-"FALSE"}
KWMSERVER_ENABLE_API_GUEST=${KWMSERVER_ENABLE_API_GUEST:-"FALSE"}
KWMSERVER_ENABLE_API_MCU=${KWMSERVER_ENABLE_API_MCU:-"FALSE"}
KWMSERVER_ENABLE_API_RTM=${KWMSERVER_ENABLE_API_RTM:-"TRUE"}
KWMSERVER_GUEST_ALLOW_JOIN_EMPTY=${KWMSERVER_GUEST_ALLOW_JOIN_EMPTY:-"FALSE"}
KWMSERVER_GUEST_PUBLIC_ACCESS_REGEXP=${KWMSERVER_GUEST_PUBLIC_ACCESS_REGEXP:-"^group/public/.*"}
KWMSERVER_HOST_SECURE=${KWMSERVER_HOST_SECURE:-"FALSE"}
KWMSERVER_LISTEN_HOST=${KWMSERVER_LISTEN_HOST:-"0.0.0.0"}
KWMSERVER_LISTEN_PORT=${KWMSERVER_LISTEN_PORT:-"8778"}
KWMSERVER_TOKENS_SECRET_KEY_FILE=${KWMSERVER_TOKENS_SECRET_KEY_FILE:-"/certs/kwm/kwm-tokens-secret.key"}
KWMSERVER_TURN_AUTH_SECRET_FILE=${KWMSERVER_TURN_AUTH_SECRET_FILE:-"/certs/kwm/kwm-turn-auth-secret.secret"}
KWMSERVER_TURN_AUTH_SERVER_FILE=${KWMSERVER_TURN_AUTH_SERVER_FILE:-"/certs/kwm/kwm-turn-auth-server.secret"}
KWMSERVER_TURN_URL=${KWMSERVER_TURN_URL:-"https://turnauth.kopano.com/turnserverauth/"}

truefalse_yesno ENABLE_COREDUMPS
####

###
if var_true "${SERVER_ENABLE_HTTP}" || var_true "${SERVER_ENABLE_HTTPS}" ; then
    if var_true "${SERVER_ENABLE_HTTPS}" ; then
        SOCKET_SERVER=${SOCKET_SERVER:-"https://server:${SERVER_LISTEN_PORT_SECURE}"}
    elif var_true "${SERVER_ENABLE_HTTP}" ; then
        SOCKET_SERVER=${SOCKET_SERVER:-"http://server:${SERVER_LISTEN_PORT}"}
    fi
    if [[ "${SOCKET_SERVER}" == *"htt"*"://server:"* ]] ; then
        if ! grep -q "127.0.0.1 server" /etc/hosts ; then
            echo "127.0.0.1 server" >> /etc/hosts
        fi
    fi
else
    SOCKET_SERVER=${SOCKET_SERVER:-"file:///var/run/kopano/server.sock"}
fi

KWMSERVER_SOCKET_SERVER=${KWMSERVER_SOCKET_SERVER:-"${SOCKET_SERVER}"}
